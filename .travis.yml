sudo: required

group: edge

services:
 - docker

before_install:
 - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
 - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
 - sudo apt-get update
 - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce

install:
 - wget https://s3.amazonaws.com/rebar3/rebar3 && chmod +x rebar3

env:
 - DOCKER_MACHINE_STATUS="Running" DOCKER_MACHINE_IP="0.0.0.0"

language: erlang
otp_release:
  - 21.0

before_script:
 - docker version
 - docker info
 - kerl list installations

script:
 - echo -e "travis_fold:start:Getting Oracle Docker DB"
 - docker pull konnexionsgmbh/db_12_2
 - docker images
 - docker create --name oranif_db -p 1521:1521/tcp -e ORACLE_PWD=oracle konnexionsgmbh/db_12_2
 - docker start oranif_db
 - echo -e "\ntravis_fold:end:Getting Oracle Docker DB\r"
 - wget -P /tmp https://github.com/K2InformaticsGmbH/oranif/wiki/travis/oracle-instantclient19.3-basic_19.3.0.0.0-2_amd64.deb
 - wget -P /tmp https://github.com/K2InformaticsGmbH/oranif/wiki/travis/oracle-instantclient19.3-sqlplus_19.3.0.0.0-2_amd64.deb
 - wget -P /tmp https://github.com/K2InformaticsGmbH/oranif/wiki/travis/db-sample-schemas-12.2.0.1.tgz
 - tar xzf /tmp/db-sample-schemas-12.2.0.1.tgz -C /tmp
 - sudo apt install /tmp/oracle-instantclient19.3-basic_19.3.0.0.0-2_amd64.deb
 - sudo apt install /tmp/oracle-instantclient19.3-sqlplus_19.3.0.0.0-2_amd64.deb
 - export LD_LIBRARY_PATH=/usr/lib/oracle/19.3/client64/lib/${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}
 - echo $LD_LIBRARY_PATH
 - ERL_INTERFACE_DIR="$(ls -d ~/otp/$TRAVIS_OTP_RELEASE/lib/erl_interface*/)"
 - OTP_ERTS_DIR="$(ls -d ~/otp/$TRAVIS_OTP_RELEASE/erts*/)"
 - export ERL_INTERFACE_DIR="${ERL_INTERFACE_DIR:0:$((${#ERL_INTERFACE_DIR} - 1))}"
 - export OTP_ERTS_DIR="${OTP_ERTS_DIR:0:$((${#OTP_ERTS_DIR} - 1))}"
 - sudo chmod +x $OTP_ERTS_DIR/bin/epmd
 - $OTP_ERTS_DIR/bin/epmd &
 - ./rebar3 version
 - ./rebar3 as test compile
 - export LD_LIBRARY_PATH=./priv/${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}
 - export LD_LIBRARY_PATH=./c_src/odpi/lib/${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}
 - for ((i = 1; i <= 7; i++)) do docker ps -a; sleep 60; done
 - docker ps
 - sudo ldconfig
 - cd /tmp/db-sample-schemas-12.2.0.1
 - perl -p -i.bak -e 's#__SUB__CWD__#'$(pwd)'#g' *.sql */*.sql */*.dat
 - echo exit | sqlplus sys/oracle@$DOCKER_MACHINE_IP:1521/orclpdb1 as sysdba @mksample oracle oracle oracle oracle oracle oracle oracle oracle users temp $(pwd)/log/ $DOCKER_MACHINE_IP:1521/orclpdb1
 - cd -
 - ./rebar3 eunit
